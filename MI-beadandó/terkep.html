<!DOCTYPE html>
<html lang="hu">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Térkép</title>
  <link rel="stylesheet" href="menu.css">

  <style>
    .racs-kontener {
      display: grid;
      grid-template-columns: repeat(20, 30px);
      grid-template-rows: repeat(20, 30px);
      gap: 2px;
      margin: 40px auto;
      background-color: #d9fcd9;
      border: 2px solid #006400;
      border-radius: 10px;
      padding: 5px;
      position: relative;
      width: fit-content;
      z-index: 1;
    }

    .cella {
      width: 30px;
      height: 30px;
      background-color: #ffffff;
      border: 1px solid #c2e5c2;
      border-radius: 4px;
      position: relative;
    }

    
    .raktar {
      background-color: #006400;
      border-radius: 50%;
      width: 22px;
      height: 22px;
      position: absolute;
      top: 4px;
      left: 4px;
      cursor: pointer;
      transition: transform 0.2s;
      z-index: 2;
    }

    .raktar:hover {
      transform: scale(1.2);
      background-color: #00a000;
    }

    
    .kor {
      position: absolute;
      background-color: rgba(0, 100, 0, 0.9);
      color: white;
      padding: 4px 8px;
      border-radius: 5px;
      font-size: 12px;
      white-space: nowrap;
      transform: translate(-50%, -120%);
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.2s;
    }

    
    .raktar:hover .kor {
      opacity: 1;
    }

    .optimalizalas-gomb {
      margin: 15px auto;
      background-color: #006400;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      font-size: 1em;
      transition: 0.3s;
      display: block;
      width: fit-content;
    }

    .optimalizalas-gomb:hover {
      background-color: #00a000;
    }

    
    #utvonalEredmeny {
      margin: 20px auto;
      background: #f0fff0;
      border: 2px solid #90EE90;
      border-radius: 10px;
      padding: 15px;
      max-width: 600px;
      font-weight: bold;
      color: #004d00;
      white-space: pre-wrap;
      display: none;
    }

    
    @media (max-width: 768px) {
      .racs-kontener {
        grid-template-columns: repeat(10, 25px);
        grid-template-rows: repeat(10, 25px);
      }
    }
  </style>
</head>

<body>

 
   <header class="menu">
    <div class="menu-bal">
      <a href="index.html" style="color:white;text-decoration:none;">
        <b><i>E-roller készletkiegyenlítő</i><br><span style="font-size:14px;">Orosz Kristóf - EYZWG9</span></b>
      </a>
    </div>
    <div class="menu-jobb">
      <a href="utvonaltervezes.html"><button class="menu-gomb" tabindex="1"><i>ÚTVONALTERVEZÉS</i></button></a>
      <a href="rakodasinaplo.html"><button class="menu-gomb" tabindex="2"><i>RAKODÁSI NAPLÓ</i></button></a>
    </div>
  </header>
 
  <div id="racs" class="racs-kontener"></div>

  <button class="optimalizalas-gomb">Optimalizálás indítása</button>

  
  <div id="utvonalEredmeny"></div>

  <script>
   
    const kivalasztottRaktarak = JSON.parse(localStorage.getItem("kivalasztottDepok") || "[]");

   
    if (kivalasztottRaktarak.length === 0) {
      alert("Nincsenek kiválasztott depók. Kérem, térjen vissza az útvonaltervezéshez!");
      window.location.href = "utvonaltervezes.html";
    }

    
    fetch("depok.php")
      .then(valasz => valasz.json())
      .then(adatok => {
        const racs = document.getElementById("racs");

       
        for (let i = 0; i < 400; i++) {
          const cella = document.createElement("div");
          cella.classList.add("cella");
          racs.appendChild(cella);
        }

       
        adatok.forEach(raktar => {
          if (kivalasztottRaktarak.includes(raktar.nev)) {
            const x = parseInt(raktar.x);
            const y = parseInt(raktar.y);
            const index = y * 20 + x;
            const cella = racs.children[index];
            if (cella) {
              const raktarElem = document.createElement("div");
              raktarElem.classList.add("raktar");
              const kor = document.createElement("div");
              kor.classList.add("kor");
              kor.textContent = `${raktar.nev}\nKészlet: ${raktar.aktualis}/${raktar.cel}`;
              raktarElem.appendChild(kor);
              cella.appendChild(raktarElem);
            }
          }
        });
      });
  </script>

<script>

function tavolsag(a, b) {
  return Math.sqrt((a.x - b.x) ** 2 + (a.y - b.y) ** 2);
}

function utHossz(ut, raktarak) {
  let hossz = 0;
  for (let i = 0; i < ut.length - 1; i++) {
    const a = raktarak.find(d => d.nev === ut[i]);
    const b = raktarak.find(d => d.nev === ut[i + 1]);
    hossz += tavolsag(a, b);
  }
  
  const elso = raktarak.find(d => d.nev === ut[0]);
  const utolso = raktarak.find(d => d.nev === ut[ut.length - 1]);
  hossz += tavolsag(utolso, elso);
  return hossz;
}


function letrehozPopulacio(raktarak, meret) {
  const populacio = [];
  const nevek = raktarak.map(r => r.nev);

  for (let i = 0; i < meret; i++) {
    const egyed = [...nevek];

    
    for (let j = egyed.length - 1; j > 0; j--) {
      const rand = Math.floor(Math.random() * (j + 1));
      [egyed[j], egyed[rand]] = [egyed[rand], egyed[j]];
    }
    populacio.push(egyed);
  }
  return populacio;
}


function rendez(pop, raktarak) {
  return pop.sort((a, b) => utHossz(a, raktarak) - utHossz(b, raktarak));
}


function keresztez(sz1, sz2) {
  const start = Math.floor(Math.random() * sz1.length);
  const end = Math.floor(Math.random() * sz1.length);

  const [min, max] = [Math.min(start, end), Math.max(start, end)];

  const resz = sz1.slice(min, max);
  const gyerek = sz2.filter(g => !resz.includes(g));
  return [...resz, ...gyerek];
}


function mutacio(egyed, p) {
  const uj = [...egyed];
  if (Math.random() < p) {
    const i = Math.floor(Math.random() * uj.length);
    const j = Math.floor(Math.random() * uj.length);
    [uj[i], uj[j]] = [uj[j], uj[i]];
  }
  return uj;
}


function genetikusAlgoritmus(raktarak, generaciok = 200, popMeret = 60) {

  let populacio = letrehozPopulacio(raktarak, popMeret);

  for (let gen = 0; gen < generaciok; gen++) {

    
    populacio = rendez(populacio, raktarak);

    const uj = [];

    
    while (uj.length < popMeret) {
      const sz1 = populacio[Math.floor(Math.random() * (popMeret / 2))];
      const sz2 = populacio[Math.floor(Math.random() * (popMeret / 2))];

      let gy = keresztez(sz1, sz2);
      gy = mutacio(gy, 0.2);

      uj.push(gy);
    }

    populacio = uj;
  }

  
  const legjobb = rendez(populacio, raktarak)[0];
  const tav = utHossz(legjobb, raktarak).toFixed(2);

  return { legjobb, tav };
}

    
    document.querySelector(".optimalizalas-gomb").addEventListener("click", () => {
      fetch("depok.php")
        .then(res => res.json())
        .then(adatok => {
          const kivalasztottRaktarak = JSON.parse(localStorage.getItem("kivalasztottDepok") || "[]");
          const aktivRaktarak = adatok.filter(d => kivalasztottRaktarak.includes(d.nev));
          const { legjobb, tav } = genetikusAlgoritmus(aktivRaktarak, 200);

          
          const eredmenyDiv = document.getElementById("utvonalEredmeny");
          eredmenyDiv.style.display = "block";
          eredmenyDiv.innerHTML = `<b>Legjobb útvonal:</b><br>${legjobb.join(" → ")}<br><br><b>Teljes távolság:</b> ${tav} egység`;

          utvonalRajzolas(legjobb, aktivRaktarak);
        });
    });
  </script>
</body>
</html>
